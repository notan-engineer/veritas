# Story 5: Add Reconciliation Summary

**Status**: Done
**Estimated Effort**: 2 hours
**Priority**: High
**Dependencies**: Story 1 (Database Verification)

## User Story

As a **developer monitoring job health**,
I want **a final reconciliation report comparing logged metrics with database reality**,
So that **I'm immediately alerted when logs don't match what's actually saved**.

## Acceptance Criteria

1. ✅ Reconciliation runs automatically after every job
2. ✅ Compares extraction counts, persistence claims, and database actuals
3. ✅ Logs detailed breakdown per source
4. ✅ Flags discrepancies with WARNING level
5. ✅ Includes severity assessment (minor/critical)

## Technical Approach

### Files to Modify
- `services/scraper/src/enhanced-scraper.ts`
- `services/scraper/src/enhanced-logger.ts`
- `services/scraper/src/types.ts`

### Implementation

1. **Add reconciliation method** (`enhanced-scraper.ts`):
   ```typescript
   private async reconcileJobMetrics(
     jobId: string,
     successfulExtractions: SourceResult[],
     persistenceResults: Map<string, SourcePersistenceResult>
   ): Promise<void> {
     // Query database for actual counts
     // Compare with logged metrics
     // Generate reconciliation report
   }
   ```

2. **Add logging method** (`enhanced-logger.ts`):
   ```typescript
   async logJobReconciliation(
     jobId: string,
     reconciliation: ReconciliationReport,
     hasDiscrepancies: boolean
   ): Promise<void>
   ```

3. **Integrate in scrapeJob**:
   - Call after verification phase
   - Before final job completion log
   - Pass all metric sources for comparison

## Testing Steps

1. Create test job with known metrics
2. Manually modify persistence logs (mock discrepancy)
3. Run reconciliation
4. Verify discrepancy detected and logged
5. Test with matching metrics (no discrepancies)

## Expected Log Output

```json
{
  "event_type": "lifecycle",
  "event_name": "job_reconciliation",
  "reconciliation": {
    "by_source": {
      "BBC News": {
        "logged_extracted": 8,
        "logged_saved": 8,
        "database_actual": 8,
        "match": true
      },
      "CNN": {
        "logged_extracted": 12,
        "logged_saved": 12,
        "database_actual": 0,
        "match": false,
        "discrepancy": -12
      }
    },
    "totals": {
      "total_logged_saved": 20,
      "total_database_actual": 8,
      "overall_discrepancy": -12
    }
  },
  "has_discrepancies": true,
  "discrepancy_severity": "critical"
}
```

## Definition of Done

- [ ] Reconciliation runs after every job
- [ ] Discrepancies detected and logged
- [ ] Severity levels assigned correctly
- [ ] Unit tests cover reconciliation logic
- [ ] Integration test validates end-to-end
- [ ] Code reviewed and merged

## Notes

- Final validation step - catches any logging bugs
- Severity levels: minor (<10% discrepancy), critical (>10%)
- Consider alerting mechanisms in future (Slack, email)
- Foundation for monitoring dashboard metrics
