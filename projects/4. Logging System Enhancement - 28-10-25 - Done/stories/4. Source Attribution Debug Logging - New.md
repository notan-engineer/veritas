# Story 4: Source Attribution Debug Logging

**Status**: Done
**Estimated Effort**: 2 hours
**Priority**: High
**Dependencies**: Story 2 (for tracking IDs)

## User Story

As a **developer debugging source attribution bugs**,
I want **detailed logs showing which source_id is used for each INSERT operation**,
So that **I can identify when articles get assigned to wrong sources**.

## Acceptance Criteria

1. ✅ Log source attribution before each database INSERT
2. ✅ Log includes source_name, source_id, source_url, and URL domain
3. ✅ Log database article ID after successful INSERT
4. ✅ Can correlate INSERT logs with article lifecycle via tracking ID
5. ✅ Failed INSERTs logged with error details

## Technical Approach

### Files to Modify
- `services/scraper/src/enhanced-scraper.ts`
- `services/scraper/src/enhanced-logger.ts`

### Implementation

1. **Add attribution logging method** (`enhanced-logger.ts`):
   ```typescript
   async logInsertAttribution(
     jobId: string,
     articleTrackingId: string,
     attribution: {
       sourceName: string;
       sourceId: string;
       sourceUrl: string;
       sourceUrlDomain: string;
     },
     insertSuccess: boolean,
     databaseArticleId?: string,
     error?: string
   ): Promise<void>
   ```

2. **Integrate in persistence loop** (`enhanced-scraper.ts`):
   - Before INSERT: Log source attribution details
   - After INSERT success: Log returned database ID
   - On INSERT failure: Log error with attribution context

3. **Extract URL domain for validation**:
   ```typescript
   const sourceUrlDomain = new URL(article.sourceUrl).hostname;
   ```

## Testing Steps

1. Run scraping job with multiple sources
2. Search logs for "article_insert_attempt" events
3. Verify source_id matches expected source for each URL domain
4. Check database article IDs match logged IDs
5. Test with intentional attribution bug (mock)

## Definition of Done

- [ ] Attribution logged before every INSERT
- [ ] Database IDs logged after successful INSERTs
- [ ] Can identify source_id used for any article
- [ ] Testing confirms attribution tracking works
- [ ] Code reviewed and merged

## Notes

- Critical for debugging the CNN/BBC attribution issue discovered
- URL domain provides quick validation (cnn.com should have CNN source_id)
- Foundation for automated attribution validation in future
